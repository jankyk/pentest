echo "Digite o IP do SIEM:"
read enderecoip
echo "Digite o nome da maquina do SIEM (SIEM-CLIENTE):"
read nomemaquina
echo "Digite o nome que ficará a sonda (ZBX-CLIENTE):"
read nomesonda
echo "Digite o IP do SonicWall que irá monitorar:"
read enderecoipsonic

echo "Importando repositorio Elastic"
rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch
cat << EOF > /etc/yum.repos.d/elasticsearch.repo
[elasticsearch-7.x]
name=Elasticsearch repository for 7.x packages
baseurl=https://artifacts.elastic.co/packages/7.x/yum
gpgcheck=1
gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch
enabled=1
autorefresh=1
type=rpm-md
EOF

echo "Importando repositorio Sonda Zabbix"
rpm -Uvh https://repo.zabbix.com/zabbix/5.2/rhel/8/x86_64/zabbix-release-5.2-1.el8.noarch.rpm

echo "Abrir portas do Zabbix no Firewall"
firewall-cmd --add-port=10050/tcp --permanent
firewall-cmd --add-port=10050/udp --permanent
firewall-cmd --add-port=10051/tcp --permanent
firewall-cmd --add-port=10051/udp --permanent
firewall-cmd --reload

echo "Atualizando o sistema"
yum update -y
timedatectl set-ntp true

echo "Instalando as ferramentas"
yum install -y java elasticsearch logstash kibana
yum install -y zabbix-proxy-mysql mariadb-server net-snmp-utils.x86_64 telnet
yum install -y zabbix-get zabbix-agent

echo "Ativando e iniciando os serviços"
systemctl enable elasticsearch logstash kibana
systemctl start elasticsearch kibana

echo "Configurando Elastic"
echo "http.max_content_length: 200mb" >> /etc/elasticsearch/elasticsearch.yml
echo "xpack.security.transport.ssl.enabled: true" >> /etc/elasticsearch/elasticsearch.yml
echo "xpack.security.enabled: true" >> /etc/elasticsearch/elasticsearch.yml
sed -i "s,#node.name: node-1,node.name: node-1,g" /etc/elasticsearch/elasticsearch.yml
sed -i "s,#cluster.initial_master_nodes: \[\"node-1\"\, \"node-2\"\],cluster.initial_master_nodes: \[\"node-1\"\],g" /etc/elasticsearch/elasticsearch.yml
sed -i "s,#cluster.name: my-application,cluster.name: $nomemaquina,g" /etc/elasticsearch/elasticsearch.yml
sed -i "s,#network.host: 192.168.0.1,network.host: $enderecoip,g" /etc/elasticsearch/elasticsearch.yml
sed -i "s,#discovery.seed_hosts: \[\"host1\"\, \"host2\"\],discovery.seed_hosts: \[\"$enderecoip\"\],g" /etc/elasticsearch/elasticsearch.yml

echo "Reiniciando serviço do Elastic"
systemctl restart elasticsearch

echo "Configurando Logstash"
sed -i "s,hosts => \[\"http://IP-DO-ELASTICSEACRH:9200\"\],hosts => \[\"http://$enderecoip:9200\"\],g" /etc/logstash/conf.d/sonicwall.conf
sed -i "s,hosts => \[\"http://IP-DO-ELASTICSEACRH:9200\"\],hosts => \[\"http://$enderecoip:9200\"\],g" /etc/logstash/conf.d/sonicwallsnmp.conf
sed -i "s,hosts => \[\{udp:IP-DO-ELASTICSEACRH,hosts => \[\{udp:$enderecoipsonic,g" /etc/logstash/conf.d/sonicwallsnmp.conf

echo "Configurando Kibana"
echo "xpack.reporting.enabled: true" >> /etc/kibana/kibana.yml
echo "xpack.reporting.csv.maxSizeBytes: 94371840" >> /etc/kibana/kibana.yml
echo "xpack.reporting.roles.allow: [ "Acesso-Cliente" ]" >> /etc/kibana/kibana.yml
sed -i "s,#elasticsearch.username: \"kibana_system\",elasticsearch.username: \"kibana_system\",g" /etc/kibana/kibana.yml
sed -i "s,#server.host: \"localhost\",server.host: \"$enderecoip\",g" /etc/kibana/kibana.yml
sed -i "s,#server.name: \"your-hostname\",server.name: \"$nomemaquina\",g" /etc/kibana/kibana.yml
sed -i "s,#elasticsearch.hosts: \[\"http://localhost:9200\"\],elasticsearch.hosts: \[\"http://$enderecoip:9200\"\],g" /etc/kibana/kibana.yml
sed -i "s,#server.publicBaseUrl: \"\",server.publicBaseUrl: \"http://$enderecoip:80\",g" /etc/kibana/kibana.yml

echo "Alterando textos do Kibana"
sed -i "s,})\, /\*#__PURE__\*/_react.default.createElement(\"title\"\, null\, \"Elastic\")\, /\*#__PURE__\*/_react.default.createElement(_fonts.Fonts\, {,})\, /\*#__PURE__\*/_react.default.createElement(\"title\"\, null\, \"SIEM Maxprotection\")\, /\*#__PURE__\*/_react.default.createElement(_fonts.Fonts\, {,g" /usr/share/kibana/src/core/server/rendering/views/template.js
sed -i "s,defaultMessage: 'Elastic did not load properly. Check the server output for more information.',defaultMessage: 'SIEM did not load properly. Check the server output for more information or contact Maxprotection.',g" /usr/share/kibana/src/core/server/rendering/views/template.js
sed -i "s,defaultMessage: 'This Elastic installation has strict security requirements enabled that your current browser does not meet.',defaultMessage: 'This SIEM installation has strict security requirements enabled that your current browser does not meet.',g" /usr/share/kibana/src/core/server/rendering/views/template.js
sed -i "s,defaultMessage: 'Loading Elastic',defaultMessage: 'Loading SIEM Maxprotection',g" /usr/share/kibana/src/core/server/rendering/views/template.js
sed -i "s,defaultMessage:\"Welcome to Elastic\",defaultMessage:\"Welcome to SIEM Maxprotection\",g" /usr/share/kibana/x-pack/plugins/security/target/public/security.chunk.4.js
sed -i "s,defaultMessage:\"Welcome to Elastic\",defaultMessage:\"Welcome to SIEM Maxprotection\",g" /usr/share/kibana/src/plugins/home/target/public/home.chunk.2.js

echo "Configurando a rotatividade"
sed -i "s,ELASTICSEARCH=\"http://192.168.0.19:9200\",ELASTICSEARCH=\"http://$enderecoip:9200\",g" /etc/cron.daily/remove-index-swl.sh

echo "Iniciando serviços do Banco de Dados e do Agent"
systemctl start mariadb
systemctl enable mariadb
systemctl start zabbix-agent
systemctl enable zabbix-agent

echo "Definindo senha do banco da Sonda"
mysqladmin -u root password thegameis1869

echo "Configurando Sonda"
sed -i "s,Server=127.0.0.1,Server=177.39.54.215,g" /etc/zabbix/zabbix_proxy.conf
sed -i "s,Hostname=Zabbix proxy,Hostname=$nomesonda,g" /etc/zabbix/zabbix_proxy.conf
sed -i "s,# EnableRemoteCommands=0,EnableRemoteCommands=1,g" /etc/zabbix/zabbix_proxy.conf
sed -i "s,DBUser=zabbix,DBUser=root,g" /etc/zabbix/zabbix_proxy.conf
sed -i "s,# DBPassword=,DBPassword=thegameis1869,g" /etc/zabbix/zabbix_proxy.conf

echo "Configurando Agent Zabbix"
sed -i "s,Server=127.0.0.1,Server=$enderecoip,g" /etc/zabbix/zabbix_agentd.conf
sed -i "s,# UserParameter=,UserParameter=serviceStatus[*]\, systemctl status \$1 | grep \"Active:\",g" /etc/zabbix/zabbix_agentd.conf
echo "UserParameter=gvpnUsers[*], snmpwalk -v 2c -c \$1 \$2 .1.3.6.1.4.1.8741.1.3.2.1.1.1.14 | grep "WAN GroupVPN" | wc -l" >> /etc/zabbix/zabbix_agentd.conf

echo "Iniciando serviços do Agent"


echo "Removendo temporarios"
rm -rf install.sh